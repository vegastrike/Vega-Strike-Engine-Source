
#!/usr/bin/env bash
#====================================
# @file   : bootstrap_mint_sdl3
# @brief  : installs dependencies for building SDL3 on Linux Mint 22.x
# @usage  : sudo script/bootstrap_mint_sdl3 Release (to build in Release mode)
#     or  : sudo script/bootstrap_mint_sdl3 Debug (to build in Release mode
# @param  : CMake build types Debug, Release, RelWithDebInfo and MinSizeReL
# @note   : Tested on Linux Mint 22.2 "zara" as of 2025-10.24
#====================================
# Copyright (C) 2025 pmx
#
# This file is part of Vega Strike.
#
# Vega Strike is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Vega Strike is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Vega Strike. If not, see <https://www.gnu.org/licenses/>.


set -e

echo "------------------------------"
echo "--- bootstrap | 2025-09-02 ---"
echo "------------------------------"

CMAKE_BUILD_TYPE="$1"

echo "Bootstrapping Vega Strike build environment for Linux Mint 22.x with SDL3 support..."
echo "Linux 22.3 'zara' doesn't have SDL3 packages yet, so we build SDL3 from source."
echo "Usage: sudo script/bootstrap_mint_sdl3 [CMake Build Type]"
echo "Supported CMake Build Types: Debug, Release, RelWithDebInfo, MinSizeRel"
echo "----------------------------------------"
if [ -z "$CMAKE_BUILD_TYPE" ]; then
    CMAKE_BUILD_TYPE="None"
    echo "No CMake Build Type specified."
    echo "Supported CMake Build Types: Debug, Release, RelWithDebInfo, MinSizeRel"
    exit 1
else
    echo "CMake Build Type: ${CMAKE_BUILD_TYPE}"
        case "$CMAKE_BUILD_TYPE" in
            "Debug"|"Release"|"RelWithDebInfo"|"MinSizeRel")
                echo "Valid CMake Build Type specified: ${CMAKE_BUILD_TYPE}"
                ;;
            *)
                echo "Invalid CMake Build Type specified: ${CMAKE_BUILD_TYPE}"
                echo "Supported CMake Build Types: Debug, Release, RelWithDebInfo, MinSizeRel"
                exit 1
                ;;
        esac 
fi
echo "----------------------------------------"     

function bootstrapSDL3LinuxMint() {
    # Install SDL3 from source, as Linux Mint does not yet have SDL3 packages
    INSTALL_DIR=${PWD}
    # Install dependencies, Linux Mint 22.x
    sudo apt-get -qy install build-essential git make \
    pkg-config cmake ninja-build gnome-desktop-testing libasound2-dev libpulse-dev \
    libaudio-dev libfribidi-dev libjack-dev libsndio-dev libx11-dev libxext-dev \
    libxrandr-dev libxcursor-dev libxfixes-dev libxi-dev libxss-dev libxtst-dev \
    libxkbcommon-dev libdrm-dev libgbm-dev libgl1-mesa-dev libgles2-mesa-dev \
    libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev libudev-dev \
    libpipewire-0.3-dev libwayland-dev libdecor-0-dev liburing-dev
    
    # As of 2025.11.24, the SDL3 version is 3.3.3
    # SDL3 Core
    if [ ! -d "SDL3-source" ]; then
        git clone https://github.com/libsdl-org/SDL.git SDL3-source
    fi 
    cd SDL3-source
    git checkout
    mkdir -p  build-${CMAKE_BUILD_TYPE}
    cmake -G Ninja -S ./ -B build-${CMAKE_BUILD_TYPE} -DCMAKE_INSTALL_PREFIX:PATH=${INSTALL_DIR} -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DSDL_EXAMPLES=OFF -DSDL_STATIC=OFF -DSDL_SHARED=ON -DSDL_TEST=OFF
    ninja -C build-${CMAKE_BUILD_TYPE}
     
    echo "INSTALL INTO ${INSTALL_DIR}"
    sudo ninja -C build-${CMAKE_BUILD_TYPE} install
    sudo sudo ldconfig
    cd ..
    SDL3_B=VERSION=
     

    # SDL3_image
    if [ ! -d "SDL3_image_source" ]; then
        git clone https://github.com/libsdl-org/SDL_image.git SDL3_image-source
    fi
    cd SDL3_image-source
    git checkout
    mkdir -p build-${CMAKE_BUILD_TYPE}
    export CMAKE_MODULES_LOCAL_DIR="${INSTALL_DIR}/lib/cmake"
    echo "CMAKE_MODULE_PATH set to ${CMAKE_MODULES_LOCAL_DIR}"
    cmake -G Ninja -S ./ -B build-${CMAKE_BUILD_TYPE} -DCMAKE_MODULE_PATH=:PATH${CMAKE_MODULES_LOCAL_DIR} -DCMAKE_INSTALL_PREFIX:PATH=${INSTALL_DIR} -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DSDL_EXAMPLES=OFF -DSDL3IMAGE_STATIC=OFF -DSDL3IMAGE_SHARED=ON -DSDL3IMAGE_TEST=OFF
    ninja -C build-${CMAKE_BUILD_TYPE}
    sudo  ninja -C build-${CMAKE_BUILD_TYPE} install
    cd ..
    sudo ldconfig

}


bootstrapSDL3LinuxMint

echo "----------------------------------------"
echo "Bootstrap completed successfully."
echo "You can now proceed to build Vega Strike with SDL3 support."
echo "----------------------------------------" 