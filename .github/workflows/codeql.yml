# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
name: CodeQL
permissions:
    contents: read
    pull-requests: read
    security-events: write

on:
  push:
    branches: [ "master" ]
  pull_request:
  schedule:
    - cron: '38 20 * * 0'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: cpp
            build-mode: manual
          - language: python
            build-mode: none
          - language: actions
            build-mode: none

    env:
      COMPILER: gcc
      INSTALL_GTEST: false
      USE_GTEST: false
      INSTALL_SDL3: false
      INSTALL_SDL3_IMAGE: false
      IS_RELEASE: 0
      # Indicates the location of vcpkg
      VCPKG_ROOT: '${{ github.workspace }}/v'
      # Tells vcpkg where binary packages are stored.
      VCPKG_DEFAULT_BINARY_CACHE: '${{ github.workspace }}/vbincache'
      # Let's use GitHub Action cache as storage for the vcpkg Binary Caching feature.
      VCPKG_BINARY_SOURCES: clear;files,${{ github.workspace }}/vcpkg_cache,readwrite
      VCPKG_FEATURE_FLAGS: "manifests,registries"
      VCPKG_DEFAULT_TRIPLET: x64-linux-sgt
      VCPKG_DEFAULT_HOST_TRIPLET: x64-linux-sgt
      PYTHONHOME: ""
      PYTHONPATH: ""


    steps:
      - name: Check out repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 2
          submodules: false

      # Initializes the CodeQL tools for scanning.
      - name: Initialize CodeQL
        uses: github/codeql-action/init@17783bfb99b07f70fae080b654aed0c514057477 #v4.30.9
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}

      - name: Restore vcpkg cache
        if: matrix.build-mode == 'manual'
        id: cache-vcpkg-restore
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ${{ github.workspace }}/vcpkg_cache
          key: vcpkg-${{ matrix.os }}-${{ matrix.triplet }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-${{ matrix.os }}-${{ matrix.triplet }}-

      - name: Setup Python
        if: matrix.build-mode == 'manual'
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        id: vega-py-setup
        with:
          python-version: ${{ matrix.python-version }}
          update-environment: false

      - name: Bootstrap
        if: matrix.build-mode == 'manual'
        shell: bash
        run: sudo script/bootstrap

      - name: install-cmake
        if: matrix.build-mode == 'manual'
        uses: lukka/get-cmake@bb2faa721a800324b726fec00f7c1ff7641964d1 # v4.2.0

      - name: run-vcpkg
        if: matrix.build-mode == 'manual'
        uses: lukka/run-vcpkg@5e0cab206a5ea620130caf672fce3e4a6b5666a1 # v11.5
        env:
          Python3_ROOT_DIR: ${{ steps.vega-py-setup.outputs.python-path }}
          Python_ROOT_DIR: ${{ steps.vega-py-setup.outputs.python-path }}
          pythonLocation: ${{ steps.vega-py-setup.outputs.python-path }}

      - name: run-cmake
        if: matrix.build-mode == 'manual'
        uses: lukka/run-cmake@af1be47fd7c933593f687731bc6fdbee024d3ff4 # v10.8
        env:
          Python3_ROOT_DIR: ${{ steps.vega-py-setup.outputs.python-path }}
          Python_ROOT_DIR: ${{ steps.vega-py-setup.outputs.python-path }}
          pythonLocation: ${{ steps.vega-py-setup.outputs.python-path }}
        with:
          configurePreset: "linux-unix-makefiles-pie-enabled-glvnd-debug-no-otel"
          buildPreset: "build-linux-unix-makefiles-pie-enabled-glvnd-debug-no-otel"
          #testPreset: "test-linux-unix-makefiles-pie-enabled-glvnd-debug-no-otel"

      - name: Save vcpkg cache
        if: matrix.build-mode == 'manual'
        id: cache-vcpkg-save
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ${{ github.workspace }}/vcpkg_cache
          key: ${{ steps.cache-vcpkg-restore.outputs.cache-primary-key }}

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@17783bfb99b07f70fae080b654aed0c514057477 #v4.30.9
        with:
          category: "/language:${{matrix.language}}"
