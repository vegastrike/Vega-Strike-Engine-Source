name: 'GH Actions - Release'
permissions:
    contents: write
    pull-requests: read

on:
  release:
    types:
      - created
      - edited

jobs:
  build:
    name: Build
    runs-on: ubuntu-24.04
    continue-on-error: true

    defaults:
      run:
        shell: bash

    strategy:
      fail-fast: false
      matrix:
        include:
          - FROM:     'ubuntu:questing'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-use-otel'
            ARTIFACT_EXT: 'deb'
          - FROM:     'ubuntu:noble'
            COMPILER: 'clang'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-use-otel'
            ARTIFACT_EXT: 'deb'
          # Source tarballs only
          - FROM:     'ubuntu:noble'
            COMPILER: 'clang'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-use-otel'
            ARTIFACT_EXT: 'tar.[xb]z*'
          - FROM:     'linuxmintd/mint22.2-amd64'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-use-otel'
            ARTIFACT_EXT: 'deb'
          - FROM:     'linuxmintd/mint22-amd64'
            COMPILER: 'clang'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-use-otel'
            ARTIFACT_EXT: 'deb'
          - FROM:     'debian:trixie'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-use-otel'
            ARTIFACT_EXT: 'deb'
          - FROM:     'debian:bookworm'
            COMPILER: 'clang'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-use-otel'
            ARTIFACT_EXT: 'deb'
          - FROM:     'fedora:43'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-enabled-glvnd-RelWithDebInfo-use-otel'
            ARTIFACT_EXT: 'rpm'
          - FROM:     'fedora:42'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-enabled-glvnd-RelWithDebInfo-use-otel'
            ARTIFACT_EXT: 'rpm'
          - FROM:     'opensuse/leap:16.0'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-enabled-glvnd-RelWithDebInfo-use-otel'
            ARTIFACT_EXT: 'rpm'
          - FROM:     'rockylinux/rockylinux:10.1'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-enabled-glvnd-RelWithDebInfo-use-otel'
            ARTIFACT_EXT: 'rpm'
          - FROM:     'ubuntu:questing'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-no-otel'
            ARTIFACT_EXT: 'deb'
          - FROM:     'ubuntu:noble'
            COMPILER: 'clang'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-no-otel'
            ARTIFACT_EXT: 'deb'
          - FROM:     'linuxmintd/mint22.2-amd64'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-no-otel'
            ARTIFACT_EXT: 'deb'
          - FROM:     'linuxmintd/mint22-amd64'
            COMPILER: 'clang'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-no-otel'
            ARTIFACT_EXT: 'deb'
          - FROM:     'debian:trixie'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-no-otel'
            ARTIFACT_EXT: 'deb'
          - FROM:     'debian:bookworm'
            COMPILER: 'clang'
            preset-name: 'linux-unix-makefiles-pie-disabled-glvnd-RelWithDebInfo-no-otel'
            ARTIFACT_EXT: 'deb'
          - FROM:     'fedora:43'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-enabled-glvnd-RelWithDebInfo-no-otel'
            ARTIFACT_EXT: 'rpm'
          - FROM:     'fedora:42'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-enabled-glvnd-RelWithDebInfo-no-otel'
            ARTIFACT_EXT: 'rpm'
          - FROM:     'opensuse/leap:16.0'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-enabled-glvnd-RelWithDebInfo-no-otel'
            ARTIFACT_EXT: 'rpm'
          - FROM:     'rockylinux/rockylinux:10.1'
            COMPILER: 'gcc'
            preset-name: 'linux-unix-makefiles-pie-enabled-glvnd-RelWithDebInfo-no-otel'
            ARTIFACT_EXT: 'rpm'

    steps:
      - name: Check out repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 2
          submodules: false

      - name: Extract tag name and short SHA
        shell: bash
        run: |
          echo "TAG_NAME=$(echo ${GITHUB_REF#refs/tags/} | sed 's/\//_/g')" >> $GITHUB_ENV
          echo "SHORT_SHA=`git rev-parse --short HEAD`" >> $GITHUB_ENV
      - name: Test tag name and short SHA
        run: |
          echo "${TAG_NAME}"
          echo "${SHORT_SHA}"
      - name: Run CI
        env:
          FROM:       ${{ matrix.FROM }}
          COMPILER:   ${{ matrix.COMPILER }}
          INSTALL_GTEST: false
          USE_GTEST: false
          INSTALL_SDL3: false
          INSTALL_SDL3_IMAGE: false
          IS_RELEASE: 1
        run: script/cibuild --from=${{ matrix.FROM }} --preset-name=${{ matrix.preset-name }}
      - name: Upload the artifacts
        uses: skx/github-action-publish-binaries@44887b225ceca96efd8a912d39c09ad70312af31 # master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT_EXT: ${{ matrix.ARTIFACT_EXT }}
        with:
          args: "packages/*.${{ matrix.ARTIFACT_EXT }}"
